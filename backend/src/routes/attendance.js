const express = require('express'); const router = express.Router(); const { requireAuth, requireSubcommitteeLeadership } = require('../middleware/auth');
router.get('/:eventId', requireAuth, async (req, res) => { const result = await db.query(` SELECT a.*, m.first_name, m.last_name, m.email FROM attendance a JOIN members m ON a.member_id = m.id WHERE a.event_id =  `, [req.params.eventId]); res.json(result.rows); });
router.post('/:eventId', requireAuth, requireSubcommitteeLeadership, async (req, res) => { const { memberId, status, notes } = req.body; const eventCheck = await db.query('SELECT associated_subcommittee_id FROM events WHERE id = ', [req.params.eventId]); if (!eventCheck.rows.length) return res.status(404).json({ error: 'Event not found' }); const subcommitteeId = eventCheck.rows[0].associated_subcommittee_id; if (!subcommitteeId) return res.status(400).json({ error: 'Attendance only for subcommittee meetings' }); const membership = await db.query('SELECT 1 FROM member_subcommittees WHERE member_id =  AND subcommittee_id = ', [memberId, subcommitteeId]); if (!membership.rows.length) return res.status(400).json({ error: 'Member not in this subcommittee' }); const result = await db.query(`INSERT INTO attendance (event_id, member_id, status, notes, recorded_by) VALUES (, , , , ) ON CONFLICT (event_id, member_id) DO UPDATE SET status = , notes = , recorded_by = , created_at = NOW() RETURNING *`, [req.params.eventId, memberId, status, notes, req.session.memberId]); res.json(result.rows[0]); });
module.exports = router;
