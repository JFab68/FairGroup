const express = require('express'); const router = express.Router(); const { body, validationResult } = require('express-validator'); const bcrypt = require('bcryptjs'); const db = require('../config/database');
router.post('/login', [body('email').isEmail(), body('password').notEmpty()], async (req, res) => { if (!validationResult(req).isEmpty()) return res.status(400).json({ errors: errors.array() }); const { email, password } = req.body; try { const result = await db.query('SELECT * FROM members WHERE email =  AND status = ', [email, 'active']); if (!result.rows.length) return res.status(401).json({ error: 'Invalid credentials' }); const member = result.rows[0]; if (!await bcrypt.compare(password, member.password_hash)) return res.status(401).json({ error: 'Invalid credentials' }); req.session.memberId = member.id; req.session.role = member.role; res.json({ id: member.id, name: `${member.first_name} ${member.last_name}`, role: member.role, email: member.email }); } catch (error) { res.status(500).json({ error: 'Server error' }); } });
router.post('/logout', (req, res) => { req.session.destroy(() => res.json({ message: 'Logged out' })); });
module.exports = router;
